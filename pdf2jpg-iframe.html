<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>PDF → JPG 변환기</title>
<style>
  :root { --gap:8px; --r:12px; }
  *{box-sizing:border-box}
  body{margin:0; font-family:system-ui, -apple-system, "Segoe UI", Roboto, Arial, "Apple SD Gothic Neo", "Malgun Gothic"; background:#f6f7f9; color:#111}
  .wrap{max-width:980px;margin:0 auto;padding:16px}
  .card{background:#fff;border:1px solid #e5e7eb;border-radius:var(--r);padding:14px;box-shadow:0 6px 18px rgba(0,0,0,.05)}
  h1{font-size:20px;margin:0 0 6px}
  .hint{font-size:13px;color:#555;margin:0 0 10px}
  .row{display:flex;flex-wrap:wrap;gap:var(--gap);align-items:center}
  .drop{flex:1;border:2px dashed #cbd5e1;border-radius:var(--r);padding:12px;text-align:center;background:#fbfcfd}
  .drop.drag{border-color:#4a8;background:#f0fff8}
  .btn{padding:8px 12px;border:1px solid #d0d7de;border-radius:10px;background:#fff;cursor:pointer;transition:transform .02s ease}
  .btn.primary{background:#111;color:#fff;border-color:#111}
  .btn[disabled]{opacity:.6; cursor:not-allowed}
  .btn:active{transform:translateY(1px)}
  .sr{position:absolute;width:1px;height:1px;clip:rect(0 0 0 0);overflow:hidden}
  .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(180px,1fr));gap:var(--gap);margin-top:12px}
  .item{border:1px solid #e6e9ee;border-radius:10px;overflow:hidden;background:#fff;display:flex;flex-direction:column}
  .ph{width:100%;aspect-ratio:4/3;object-fit:contain;background:#f3f4f6}
  .meta{padding:8px;font-size:12px;display:flex;align-items:center;gap:8px;justify-content:space-between}
  .ctl{display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:var(--gap);margin-top:12px}
  label{font-size:13px;color:#333}
  select,input[type="number"],input[type="text"],input[type="range"],input[type="color"],input[type="password"]{
    width:100%;padding:8px;border:1px solid #dde1e6;border-radius:10px;background:#fff
  }
  .note{font-size:12px;color:#666}
  .footer{display:flex;gap:var(--gap);flex-wrap:wrap;align-items:center;margin-top:12px}
  .status{font-size:12px;color:#555;margin-top:8px}
  progress{width:220px;height:10px}
</style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <h1>PDF → JPG 변환</h1>
      <p class="hint">PDF 각 페이지를 JPG 이미지로 변환합니다. 페이지 범위, DPI(해상도), JPEG 품질을 설정할 수 있어요.</p>

      <div class="row">
        <div id="drop" class="drop">
          <p style="margin:6px 0">여기에 PDF를 드래그하거나 아래 버튼으로 선택하세요.</p>
          <label class="btn" for="pdfFile">PDF 파일 선택</label>
          <input id="pdfFile" class="sr" type="file" accept="application/pdf" />
          <button id="clear" class="btn" type="button">초기화</button>
          <div id="engineStatus" class="status">엔진 로드 중…</div>
        </div>
      </div>

      <div class="ctl">
        <label>페이지 범위 (예: 1-3,5 / 비우면 전체)
          <input id="pageRange" type="text" placeholder="전체 페이지" />
        </label>
        <label>DPI (72–300 권장)
          <input id="dpi" type="number" min="50" max="600" step="10" value="200" />
        </label>
        <label>JPEG 품질
          <input id="quality" type="range" min="0.6" max="0.95" step="0.01" value="0.85" />
        </label>
        <label>배경색 (투명 영역)
          <input id="bg" type="color" value="#ffffff" />
        </label>
        <label>파일명 접두사
          <input id="prefix" type="text" value="page" />
        </label>
        <label>비밀번호 (필요한 PDF만)
          <input id="password" type="password" placeholder="옵션" />
        </label>
      </div>

      <div class="footer">
        <button id="convert" class="btn primary" type="button" disabled>변환 시작</button>
        <button id="downloadZip" class="btn" type="button" disabled>전체 ZIP 다운로드</button>
        <div class="row" style="gap:8px;align-items:center">
          <progress id="prog" max="100" value="0" style="display:none"></progress>
          <span id="progText" class="status"></span>
        </div>
        <span class="note">* 페이지 수·DPI가 클수록 시간과 메모리를 더 사용합니다.</span>
      </div>

      <div id="results" class="grid" aria-live="polite"></div>
    </div>
  </div>

<!-- ===== 라이브러리 동적 로더 (CDN → 폴백) ===== -->
<script>
(function loadLibs(){
  const statusEl = document.getElementById('engineStatus');
  const convertBtn = document.getElementById('convert');

  // pdf.js v2 (UMD) 사용 — 브라우저 호환성 높음
  const cdn = {
    pdf: "https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.min.js",
    worker: "https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.worker.min.js",
    jszip: "https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js",
    filesaver: "https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"
  };
  const fall = {
    pdf: "https://cdn.jsdelivr.net/npm/pdfjs-dist@2.16.105/build/pdf.min.js",
    worker: "https://cdn.jsdelivr.net/npm/pdfjs-dist@2.16.105/build/pdf.worker.min.js",
    jszip: "https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js",
    filesaver: "https://cdn.jsdelivr.net/npm/file-saver@2.0.5/dist/FileSaver.min.js"
  };

  function inject(src){ return new Promise((res,rej)=>{ const s=document.createElement('script'); s.src=src; s.onload=res; s.onerror=rej; document.head.appendChild(s); }); }
  (async ()=>{
    try{
      await inject(cdn.pdf); await inject(cdn.worker);
      // workerSrc 안전설정
      if (window['pdfjsLib']) {
        window['pdfjsLib'].GlobalWorkerOptions.workerSrc = cdn.worker;
      }
    }catch{
      statusEl.textContent = "기본 CDN 실패 → 대체 CDN 시도 중…";
      await inject(fall.pdf); await inject(fall.worker);
      if (window['pdfjsLib']) {
        window['pdfjsLib'].GlobalWorkerOptions.workerSrc = fall.worker;
      }
    }
    try{
      await inject(cdn.jszip);
    }catch{ await inject(fall.jszip); }
    try{
      await inject(cdn.filesaver);
    }catch{ await inject(fall.filesaver); }

    if (window['pdfjsLib'] && window['JSZip'] && window['saveAs']) {
      statusEl.textContent = "엔진 준비 완료.";
      convertBtn.disabled = false;
    } else {
      statusEl.textContent = "엔진 로드 오류. 네트워크/차단을 확인하세요.";
    }
  })();
})();
</script>

<!-- ===== 앱 로직 ===== -->
<script>
(function(){
  const $ = s => document.querySelector(s);
  const drop = $('#drop'), pdfInput = $('#pdfFile'), clearBtn = $('#clear');
  const convertBtn = $('#convert'), downloadZipBtn = $('#downloadZip');
  const pageRange = $('#pageRange'), dpiInput = $('#dpi'), qualityInput = $('#quality');
  const bgInput = $('#bg'), prefixInput = $('#prefix'), passInput = $('#password');
  const results = $('#results'), prog = $('#prog'), progText = $('#progText');

  let pdfFile = null;
  let images = []; // {name, blob, url}

  // 드래그&드롭
  drop.addEventListener('dragover', e => { e.preventDefault(); drop.classList.add('drag'); });
  drop.addEventListener('dragleave', () => drop.classList.remove('drag'));
  drop.addEventListener('drop', e => {
    e.preventDefault(); drop.classList.remove('drag');
    if (!e.dataTransfer.files?.length) return;
    const f = e.dataTransfer.files[0];
    if (f && f.type === 'application/pdf') setPdf(f);
    else alert('PDF 파일을 올려주세요.');
  });

  // 파일 선택
  pdfInput.addEventListener('change', e => {
    const f = e.target.files?.[0]; if (f) setPdf(f);
  });

  // 초기화
  clearBtn.addEventListener('click', resetAll);

  function setPdf(f){
    resetResults();
    pdfFile = f;
    $('#engineStatus').textContent = `선택됨: ${f.name} (${fmtBytes(f.size)})`;
  }

  function resetResults(){
    images.forEach(it => URL.revokeObjectURL(it.url));
    images = [];
    results.innerHTML = '';
    prog.style.display = 'none'; prog.value = 0; progText.textContent = '';
    downloadZipBtn.disabled = true;
  }
  function resetAll(){
    resetResults();
    pdfFile = null;
    pdfInput.value = '';
    $('#engineStatus').textContent = '엔진 준비 완료.';
  }

  // 변환 시작
  convertBtn.addEventListener('click', async ()=>{
    if (!window['pdfjsLib'] || !window['JSZip'] || !window['saveAs']) {
      alert('엔진이 준비되지 않았어요. 새로고침 후 다시 시도해 주세요.');
      return;
    }
    if (!pdfFile) { alert('먼저 PDF를 선택해 주세요.'); return; }

    resetResults();
    convertBtn.disabled = true; clearBtn.disabled = true;

    try{
      const pdfData = await readAsArrayBuffer(pdfFile);
      const loadingTask = pdfjsLib.getDocument({ data: pdfData, password: passInput.value || undefined });

      // 비밀번호 요청 핸들링
      loadingTask.onPassword = (updatePassword, reason) => {
        if (reason === pdfjsLib.PasswordResponses.NEED_PASSWORD) {
          const entered = prompt('PDF 비밀번호를 입력하세요') || '';
          updatePassword(entered);
        } else if (reason === pdfjsLib.PasswordResponses.INCORRECT_PASSWORD) {
          const entered = prompt('비밀번호가 틀렸어요. 다시 입력하세요') || '';
          updatePassword(entered);
        }
      };

      const pdf = await loadingTask.promise;
      const total = pdf.numPages;

      const range = parseRange(pageRange.value, total); // 배열(1-based)
      if (range.length === 0) {
        alert('페이지 범위가 유효하지 않습니다. 예: 1-3,5');
        throw new Error('Invalid range');
      }

      const dpi = clamp(Number(dpiInput.value)||200, 50, 600);
      const scale = dpi / 96; // 1 CSS px ≈ 1/96 inch 기준
      const quality = clamp(Number(qualityInput.value)||0.85, 0.6, 0.95);
      const bg = bgInput.value || '#ffffff';
      const prefix = (prefixInput.value || 'page').replace(/[^-_a-zA-Z0-9]/g, '_');

      prog.style.display = 'inline-block';
      prog.max = range.length; prog.value = 0;
      progText.textContent = `0 / ${range.length} 변환 준비…`;

      // 순차 처리(메모리 효율)
      for (let i = 0; i < range.length; i++) {
        const p = range[i];
        const page = await pdf.getPage(p);
        const viewport = page.getViewport({ scale });

        const canvas = document.createElement('canvas');
        canvas.width = Math.floor(viewport.width);
        canvas.height = Math.floor(viewport.height);
        const ctx = canvas.getContext('2d', { willReadFrequently: false });

        // 배경색 칠하기(투명 방지)
        ctx.save();
        ctx.fillStyle = bg;
        ctx.fillRect(0, 0, canvas.width, canvas.height);
        ctx.restore();

        await page.render({ canvasContext: ctx, viewport }).promise;

        const blob = await canvasToBlob(canvas, 'image/jpeg', quality);
        const name = `${prefix}_${String(p).padStart(3,'0')}.jpg`;
        const url = URL.createObjectURL(blob);

        images.push({ name, blob, url });
        appendResultCard(url, name, blob);

        prog.value = i + 1;
        progText.textContent = `${i + 1} / ${range.length} 변환 완료`;
        // 메모리 해제
        ctx && ctx.canvas && (ctx.canvas.width = ctx.canvas.height = 0);
      }

      downloadZipBtn.disabled = images.length === 0;
      if (images.length) {
        progText.textContent = `완료! 총 ${images.length}장 생성`;
      }
    } catch (e) {
      console.error(e);
      alert('변환 중 오류가 발생했어요. 비밀번호, 페이지 범위, DPI를 확인해 주세요.');
    } finally {
      convertBtn.disabled = false; clearBtn.disabled = false;
    }
  });

  // 결과 카드 추가
  function appendResultCard(url, name, blob){
    const div = document.createElement('div'); div.className = 'item';
    const img = document.createElement('img'); img.className='ph'; img.src = url; img.alt = name;
    const meta = document.createElement('div'); meta.className='meta';
    const nm = document.createElement('div'); nm.textContent = name;
    const dl = document.createElement('button'); dl.className='btn'; dl.textContent='다운로드';
    dl.addEventListener('click', ()=> saveAs(blob, name));
    meta.append(nm, dl);
    div.append(img, meta);
    results.append(div);
  }

  // ZIP 다운로드
  downloadZipBtn.addEventListener('click', async ()=>{
    if (!images.length) return;
    downloadZipBtn.disabled = true;
    try{
      const zip = new JSZip();
      const folder = zip.folder('images') || zip;
      images.forEach(it => folder.file(it.name, it.blob));
      const blob = await zip.generateAsync({ type:'blob' });
      saveAs(blob, 'images.zip');
    } catch (e) {
      console.error(e);
      alert('ZIP 생성 중 오류가 발생했어요.');
    } finally {
      downloadZipBtn.disabled = false;
    }
  });

  // 유틸
  function clamp(v,min,max){ return Math.max(min, Math.min(max, v)); }
  function fmtBytes(b){
    if (!b && b !== 0) return '';
    const u = ['B','KB','MB','GB']; let i=0; let n=b;
    while(n>=1024 && i<u.length-1){ n/=1024; i++; }
    return `${n.toFixed(1)} ${u[i]}`;
  }
  function readAsArrayBuffer(file){
    return new Promise((res,rej)=>{ const r=new FileReader(); r.onload=e=>res(e.target.result); r.onerror=rej; r.readAsArrayBuffer(file); });
  }
  function canvasToBlob(canvas, type, quality){
    return new Promise(res => canvas.toBlob(b => res(b), type, quality));
  }
  function parseRange(text, max){
    const s = (text||'').trim();
    if (!s) return Array.from({length:max}, (_,i)=>i+1);
    const out = new Set();
    s.split(',').forEach(part=>{
      const t = part.trim();
      if (!t) return;
      if (t.includes('-')){
        const [a,b] = t.split('-').map(x=>parseInt(x.trim(),10));
        if (Number.isInteger(a) && Number.isInteger(b) && a>=1 && b>=1){
          const start = Math.min(a,b), end = Math.max(a,b);
          for (let n=start; n<=end && n<=max; n++) out.add(n);
        }
      } else {
        const n = parseInt(t,10);
        if (Number.isInteger(n) && n>=1 && n<=max) out.add(n);
      }
    });
    return Array.from(out).sort((a,b)=>a-b);
  }

  // 메모리 정리
  window.addEventListener('beforeunload', ()=> images.forEach(it => URL.revokeObjectURL(it.url)));
})();
</script>
</body>
</html>

