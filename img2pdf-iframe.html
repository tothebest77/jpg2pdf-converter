<!-- 파일명 예: img2pdf-iframe.html -->
<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>이미지 → PDF 변환기 (iframe)</title>
<link rel="preconnect" href="https://cdnjs.cloudflare.com" />
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js" defer></script>
<style>
  :root { --gap:8px; --r:12px; }
  *{box-sizing:border-box}
  body{margin:0; font-family:system-ui, -apple-system, "Segoe UI", Roboto, Arial, "Apple SD Gothic Neo", "Malgun Gothic"; background:#f6f7f9; color:#111}
  .wrap{max-width:860px;margin:0 auto;padding:14px}
  .card{background:#fff;border:1px solid #e5e7eb;border-radius:var(--r);padding:14px;box-shadow:0 6px 18px rgba(0,0,0,.05)}
  h1{font-size:18px;margin:0 0 6px}
  .hint{font-size:13px;color:#555;margin:0 0 8px}
  .row{display:flex;flex-wrap:wrap;gap:var(--gap)}
  .drop{flex:1;border:2px dashed #cbd5e1;border-radius:var(--r);padding:12px;text-align:center;background:#fbfcfd}
  .drop.drag{border-color:#4a8;background:#f0fff8}
  .btn{padding:8px 12px;border:1px solid #d0d7de;border-radius:10px;background:#fff;cursor:pointer}
  .btn.primary{background:#111;color:#fff;border-color:#111}
  .btn:active{transform:translateY(1px)}
  .sr{position:absolute;width:1px;height:1px;clip:rect(0 0 0 0);overflow:hidden}
  .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(130px,1fr));gap:var(--gap);margin-top:10px}
  .item{border:1px solid #e6e9ee;border-radius:10px;overflow:hidden;background:#fff}
  .ph{width:100%;aspect-ratio:4/3;object-fit:cover;background:#f3f4f6}
  .meta{display:flex;gap:6px;padding:8px}
  .mini .btn{padding:6px;font-size:12px}
  .mini{display:flex;gap:6px;margin-left:auto}
  .ctl{display:grid;grid-template-columns:repeat(auto-fit,minmax(160px,1fr));gap:var(--gap);margin-top:10px}
  select,input[type="number"]{width:100%;padding:8px;border:1px solid #dde1e6;border-radius:10px;background:#fff}
  .note{font-size:12px;color:#666}
  .footer{display:flex;gap:var(--gap);flex-wrap:wrap;align-items:center;margin-top:10px}
</style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <h1>이미지를 PDF로 변환</h1>
      <p class="hint">JPG/JPEG/PNG 여러 장을 한 개의 PDF로 만들 수 있어요. 썸네일에서 순서 변경/삭제 가능.</p>

      <div class="row">
        <div id="drop" class="drop">
          <p style="margin:6px 0">여기로 드래그하거나 아래 버튼으로 선택하세요.</p>
          <label class="btn" for="files">파일 선택</label>
          <input id="files" class="sr" type="file" accept="image/png,image/jpeg" multiple />
          <button id="clear" class="btn" type="button">초기화</button>
          <p class="note" style="margin-top:6px">* 이미지가 많거나 해상도가 큰 경우 생성 시간이 길어질 수 있어요.</p>
        </div>
      </div>

      <div class="ctl">
        <label>용지 크기
          <select id="size">
            <option value="a4">A4</option>
            <option value="letter">Letter</option>
            <option value="legal">Legal</option>
            <option value="a3">A3</option>
            <option value="a5">A5</option>
          </select>
        </label>
        <label>방향
          <select id="ori">
            <option value="portrait">세로</option>
            <option value="landscape">가로</option>
          </select>
        </label>
        <label>여백(mm)
          <input id="margin" type="number" min="0" max="40" step="1" value="10" />
        </label>
        <label>맞춤
          <select id="fit">
            <option value="contain">비율 유지</option>
            <option value="cover">페이지 채우기</option>
            <option value="original">원본 크기</option>
          </select>
        </label>
        <label style="display:flex;align-items:center;gap:8px">
          <input id="flatten" type="checkbox" />
          <span>PNG 투명 배경 흰색 처리</span>
        </label>
        <label style="display:flex;align-items:center;gap:8px">
          <input id="open" type="checkbox" />
          <span>다운로드 대신 새 탭 열기</span>
        </label>
      </div>

      <div id="list" class="grid" aria-live="polite"></div>

      <div class="footer">
        <button id="make" class="btn primary" type="button">PDF 만들기</button>
        <button id="sort" class="btn" type="button">파일명 정렬</button>
        <span class="note">모바일에서 다운로드 막힐 때는 “새 탭 열기”를 체크하세요.</span>
      </div>
    </div>
  </div>

<script>
(function(){
  const { jsPDF } = window.jspdf || {};
  const $ = s => document.querySelector(s);
  const drop = $('#drop'), fi = $('#files'), list = $('#list');
  const size = $('#size'), ori = $('#ori'), margin = $('#margin');
  const fit = $('#fit'), flatten = $('#flatten'), openNew = $('#open');
  const make = $('#make'), sort = $('#sort'), clear = $('#clear');

  let items = []; // {file,name,url,type}

  function add(fs){
    Array.from(fs||[]).filter(f=>/image\/(jpeg|png)/i.test(f.type)).forEach(f=>{
      items.push({file:f,name:f.name,type:f.type,url:URL.createObjectURL(f)});
    });
    render();
  }
  function render(){
    list.innerHTML = '';
    items.forEach((it,i)=>{
      const div = document.createElement('div'); div.className='item';
      const img = document.createElement('img'); img.className='ph'; img.src=it.url; img.alt=it.name;
      const meta = document.createElement('div'); meta.className='meta';
      const name = document.createElement('div'); name.style.fontSize='12px'; name.style.wordBreak='break-all'; name.textContent = it.name;
      const mini = document.createElement('div'); mini.className='mini';
      mini.append(btn('↑',()=>move(i,-1)), btn('↓',()=>move(i,1)), btn('삭제',()=>del(i)));
      meta.append(name,mini); div.append(img,meta); list.append(div);
    });
  }
  function btn(t,fn){ const b=document.createElement('button'); b.className='btn'; b.type='button'; b.textContent=t; b.onclick=fn; return b; }
  function move(i,d){ const j=i+d; if(j<0||j>=items.length) return; [items[i],items[j]]=[items[j],items[i]]; render(); }
  function del(i){ URL.revokeObjectURL(items[i].url); items.splice(i,1); render(); }
  function reset(){ items.forEach(it=>URL.revokeObjectURL(it.url)); items=[]; render(); }

  drop.addEventListener('dragover',e=>{e.preventDefault(); drop.classList.add('drag');});
  drop.addEventListener('dragleave',()=>drop.classList.remove('drag'));
  drop.addEventListener('drop',e=>{e.preventDefault(); drop.classList.remove('drag'); add(e.dataTransfer.files);});
  fi.addEventListener('change',e=>add(e.target.files));
  clear.addEventListener('click',reset);
  sort.addEventListener('click',()=>{ items.sort((a,b)=>a.name.localeCompare(b.name,'ko',{numeric:true,sensitivity:'base'})); render(); });

  make.addEventListener('click', async ()=>{
    if(!window.jspdf||!jsPDF){ alert('PDF 엔진이 아직 로드되지 않았어요. 잠시 후 다시 시도해 주세요.'); return; }
    if(!items.length){ alert('이미지를 먼저 추가해 주세요.'); return; }

    const doc = new jsPDF({orientation:ori.value, unit:'mm', format:size.value, compress:true});
    try{
      for(let i=0;i<items.length;i++){
        if(i>0) doc.addPage();
        const data = await toDataURL(items[i].file, flatten.checked);
        const img = await loadImg(data);
        const pageW = doc.internal.pageSize.getWidth(), pageH = doc.internal.pageSize.getHeight();
        const m = Math.max(0, Number(margin.value)||0);
        const boxW = Math.max(0, pageW-2*m), boxH = Math.max(0, pageH-2*m);
        const iw = img.naturalWidth||img.width, ih = img.naturalHeight||img.height;
        let w, h;
        if(fit.value==='original'){ w = iw*0.264583; h = ih*0.264583; }
        else{
          const br = boxW/boxH, ir = iw/ih;
          if(fit.value==='contain'){ if(ir>br){ w=boxW; h=w/ir; } else { h=boxH; w=h*ir; } }
          else{ // cover
            if(ir>br){ h=boxH; w=h*ir; } else { w=boxW; h=w/ir; }
          }
        }
        let x=(pageW-w)/2, y=(pageH-h)/2;
        if(fit.value!=='original'){ x=Math.max(m,x); y=Math.max(m,y); }
        const type = data.startsWith('data:image/png') ? 'PNG' : 'JPEG';
        doc.addImage(data, type, x, y, w, h);
      }
      if(openNew.checked){ const url = doc.output('bloburl'); window.open(url, '_blank'); }
      else{ doc.save('images.pdf'); }
    }catch(e){ console.error(e); alert('PDF 생성 중 오류가 발생했어요. 해상도/개수를 줄여 다시 시도해 주세요.'); }
  });

  async function toDataURL(file, whiteBgForPng){
    const data = await read(file);
    if(!whiteBgForPng || !/^image\/png$/i.test(file.type)) return data;
    const img = await loadImg(data);
    const w = img.naturalWidth||img.width, h = img.naturalHeight||img.height;
    const MAX = 24_000_000; let cw=w, ch=h; const px=w*h;
    if(px>MAX){ const s=Math.sqrt(MAX/px); cw=Math.max(1, (w*s)|0); ch=Math.max(1, (h*s)|0); }
    const c=document.createElement('canvas'); c.width=cw; c.height=ch;
    const g=c.getContext('2d'); g.fillStyle='#fff'; g.fillRect(0,0,cw,ch);
    if(cw!==w||ch!==h) g.drawImage(img,0,0,w,h,0,0,cw,ch); else g.drawImage(img,0,0);
    return c.toDataURL('image/jpeg', .92);
  }
  function read(f){ return new Promise((res,rej)=>{ const r=new FileReader(); r.onload=e=>res(e.target.result); r.onerror=rej; r.readAsDataURL(f); }); }
  function loadImg(src){ return new Promise((res,rej)=>{ const i=new Image(); i.crossOrigin='anonymous'; i.onload=()=>res(i); i.onerror=rej; i.src=src; }); }
})();
</script>
</body>
</html>
