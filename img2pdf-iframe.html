<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>이미지 → PDF 변환기 (BMP → JPEG 옵션 포함)</title>
<style>
  :root { --gap:8px; --r:12px; }
  *{box-sizing:border-box}
  body{margin:0; font-family:system-ui, -apple-system, "Segoe UI", Roboto, Arial, "Apple SD Gothic Neo", "Malgun Gothic"; background:#f6f7f9; color:#111}
  .wrap{max-width:860px;margin:0 auto;padding:14px}
  .card{background:#fff;border:1px solid #e5e7eb;border-radius:var(--r);padding:14px;box-shadow:0 6px 18px rgba(0,0,0,.05)}
  h1{font-size:18px;margin:0 0 6px}
  .hint{font-size:13px;color:#555;margin:0 0 8px}
  .row{display:flex;flex-wrap:wrap;gap:var(--gap)}
  .drop{flex:1;border:2px dashed #cbd5e1;border-radius:var(--r);padding:12px;text-align:center;background:#fbfcfd}
  .drop.drag{border-color:#4a8;background:#f0fff8}
  .btn{padding:8px 12px;border:1px solid #d0d7de;border-radius:10px;background:#fff;cursor:pointer;transition:transform .02s ease}
  .btn:active{transform:translateY(1px)}
  .btn.primary{background:#111;color:#fff;border-color:#111}
  .btn[disabled]{opacity:.6; cursor:not-allowed}
  .sr{position:absolute;width:1px;height:1px;clip:rect(0 0 0 0);overflow:hidden}
  .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(130px,1fr));gap:var(--gap);margin-top:10px}
  .item{border:1px solid #e6e9ee;border-radius:10px;overflow:hidden;background:#fff}
  .ph{width:100%;aspect-ratio:4/3;object-fit:cover;background:#f3f4f6}
  .meta{display:flex;gap:6px;align-items:center;padding:8px}
  .name{font-size:12px; word-break:break-all}
  .mini{display:flex;gap:6px;margin-left:auto}
  .mini .btn{padding:6px;font-size:12px}
  .ctl{display:grid;grid-template-columns:repeat(auto-fit,minmax(160px,1fr));gap:var(--gap);margin-top:10px}
  select,input[type="number"],input[type="range"]{width:100%;padding:8px;border:1px solid #dde1e6;border-radius:10px;background:#fff}
  .note{font-size:12px;color:#666}
  .footer{display:flex;gap:var(--gap);flex-wrap:wrap;align-items:center;margin-top:10px}
  .status{font-size:12px;color:#555;margin-top:8px}
  .rowline{display:flex; gap:10px; align-items:center}
  .rowline label{display:flex; align-items:center; gap:8px}
  .muted{color:#888; font-size:12px}
</style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <h1>이미지 → PDF 변환</h1>
      <p class="hint">JPG/JPEG/PNG/BMP 여러 장을 한 개의 PDF로 만들 수 있어요. 썸네일에서 순서 변경/삭제 가능.</p>

      <div class="row">
        <div id="drop" class="drop">
          <p style="margin:6px 0">여기로 드래그하거나 아래 버튼으로 선택하세요.</p>
          <label class="btn" for="files">파일 선택</label>
          <input id="files" class="sr" type="file" accept="image/png,image/jpeg,image/bmp" multiple />
          <button id="clear" class="btn" type="button">초기화</button>
          <div id="engineStatus" class="status">PDF 엔진 로드 중…</div>
        </div>
      </div>

      <div class="ctl" style="margin-top:12px">
        <label>용지 크기
          <select id="size">
            <option value="a4">A4</option>
            <option value="letter">Letter</option>
            <option value="legal">Legal</option>
            <option value="a3">A3</option>
            <option value="a5">A5</option>
          </select>
        </label>
        <label>방향
          <select id="ori">
            <option value="portrait">세로</option>
            <option value="landscape">가로</option>
          </select>
        </label>
        <label>여백(mm)
          <input id="margin" type="number" min="0" max="40" step="1" value="10" />
        </label>
        <label>맞춤
          <select id="fit">
            <option value="contain">비율 유지(여백)</option>
            <option value="cover">페이지 채우기(잘릴 수 있음)</option>
            <option value="original">원본 크기</option>
          </select>
        </label>
        <div>
          <label class="rowline">
            <input id="flatten" type="checkbox" />
            <span>PNG 투명 배경 흰색 처리</span>
          </label>
          <div class="muted">PNG에만 적용. 투명 영역이 흰색으로 합성되어 PDF에 들어갑니다.</div>
        </div>
        <div>
          <label class="rowline">
            <input id="bmpAutoJpeg" type="checkbox" checked />
            <span>BMP 자동 JPEG 변환(용량 줄이기)</span>
          </label>
          <div>
            <label>JPEG 품질 (BMP 전용)
              <input id="bmpQuality" type="range" min="0.5" max="0.95" step="0.05" value="0.85" />
            </label>
            <div class="muted">값이 클수록 화질↑/용량↑. 기본 0.85</div>
          </div>
        </div>
        <div>
          <label class="rowline">
            <input id="open" type="checkbox" />
            <span>다운로드 대신 새 탭 열기</span>
          </label>
          <div class="muted">모바일에서 다운로드가 막힐 때 유용합니다.</div>
        </div>
      </div>

      <div id="list" class="grid" aria-live="polite"></div>

      <div class="footer">
        <button id="make" class="btn primary" type="button" disabled>PDF 만들기</button>
        <button id="sort" class="btn" type="button" disabled>파일명 정렬</button>
        <span class="note">* BMP는 용량이 매우 클 수 있어요. 자동 JPEG 변환을 권장합니다.</span>
      </div>
    </div>
  </div>

<!-- ===== jsPDF 동적 로더: CDN → 폴백 → (선택) 로컬 ===== -->
<script>
(function loadJsPDF(){
  const statusEl = document.getElementById('engineStatus');
  const makeBtn = document.getElementById('make');
  const sortBtn = document.getElementById('sort');

  function ready(){
    if (window.jspdf && window.jspdf.jsPDF) {
      statusEl.textContent = 'PDF 엔진 준비 완료.';
      makeBtn.disabled = false;
      sortBtn.disabled = false;
      return true;
    }
    return false;
  }
  function inject(src, onok, onfail){
    const s = document.createElement('script');
    s.src = src;
    s.onload = onok;
    s.onerror = onfail;
    document.head.appendChild(s);
  }

  // 1차: cdnjs
  inject(
    "https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js",
    () => { if (!ready()) statusEl.textContent = '엔진 로드 오류'; },
    () => {
      statusEl.textContent = "기본 CDN 실패 → 대체 CDN 시도 중…";
      // 2차: jsDelivr
      inject(
        "https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js",
        () => { if (!ready()) statusEl.textContent = '엔진 로드 오류'; },
        () => {
          statusEl.textContent = "CDN 로드 실패. 네트워크/차단을 확인하세요.";
          // 3차(선택): 같은 폴더에 jsPDF 파일을 둘 경우, 아래 한 줄 주석 해제
          // inject("./jspdf.umd.min.js", () => { if (!ready()) statusEl.textContent='엔진 로드 오류'; }, () => { statusEl.textContent='로컬 로드 실패'; });
        }
      );
    }
  );
})();
</script>

<!-- ===== 앱 로직 ===== -->
<script>
(function(){
  const $ = s => document.querySelector(s);
  const drop = $('#drop'), fi = $('#files'), list = $('#list');
  const size = $('#size'), ori = $('#ori'), margin = $('#margin'), fit = $('#fit');
  const flatten = $('#flatten'), openNew = $('#open');
  const bmpAutoJpeg = $('#bmpAutoJpeg'), bmpQuality = $('#bmpQuality');
  const make = $('#make'), sort = $('#sort'), clearBtn = $('#clear');

  // 품질 슬라이더 활성/비활성
  function toggleBmpQuality(){ bmpQuality.disabled = !bmpAutoJpeg.checked; }
  bmpAutoJpeg.addEventListener('change', toggleBmpQuality);
  toggleBmpQuality();

  let items = []; // {file,name,url,type}

  function add(fs){
    Array.from(fs||[])
      .filter(f => /image\/(jpeg|png|bmp)/i.test(f.type))
      .forEach(f=>{
        items.push({file:f,name:f.name,type:f.type,url:URL.createObjectURL(f)});
      });
    render();
  }
  function render(){
    list.innerHTML = '';
    items.forEach((it,i)=>{
      const d=document.createElement('div'); d.className='item';
      const img=document.createElement('img'); img.className='ph'; img.src=it.url; img.alt=it.name;
      const m=document.createElement('div'); m.className='meta';
      const nm=document.createElement('div'); nm.className='name'; nm.textContent=it.name;
      const mm=document.createElement('div'); mm.className='mini';
      mm.append(btn('↑',()=>mv(i,-1)), btn('↓',()=>mv(i,1)), btn('삭제',()=>del(i)));
      m.append(nm,mm); d.append(img,m); list.append(d);
    });
  }
  function btn(t,fn){ const b=document.createElement('button'); b.className='btn'; b.type='button'; b.textContent=t; b.onclick=fn; return b; }
  function mv(i,d){ const j=i+d; if(j<0||j>=items.length) return; [items[i],items[j]]=[items[j],items[i]]; render(); }
  function del(i){ URL.revokeObjectURL(items[i].url); items.splice(i,1); render(); }
  function reset(){ items.forEach(it=>URL.revokeObjectURL(it.url)); items=[]; render(); }
  if (clearBtn) clearBtn.addEventListener('click', reset);

  // 드래그&드롭
  drop.addEventListener('dragover',e=>{e.preventDefault(); drop.classList.add('drag');});
  drop.addEventListener('dragleave',()=>drop.classList.remove('drag'));
  drop.addEventListener('drop',e=>{e.preventDefault(); drop.classList.remove('drag'); add(e.dataTransfer.files);});

  // 파일 선택
  fi.addEventListener('change',e=>add(e.target.files));

  // 파일명 정렬
  sort.addEventListener('click',()=>{
    items.sort((a,b)=>a.name.localeCompare(b.name,'ko',{numeric:true,sensitivity:'base'}));
    render();
  });

  // PDF 만들기
  make.addEventListener('click', async ()=>{
    if (!window.jspdf || !window.jspdf.jsPDF) {
      alert("PDF 엔진이 아직 준비되지 않았어요. 잠시 후 다시 시도해 주세요.");
      return;
    }
    if (!items.length) {
      alert('이미지를 먼저 추가해 주세요.');
      return;
    }

    const { jsPDF } = window.jspdf;
    const orientation = ori.value;
    const format = size.value;
    const doc = new jsPDF({ orientation, unit:'mm', format, compress:true });

    try{
      for(let i=0;i<items.length;i++){
        if(i>0) doc.addPage();

        // 파일을 DataURL로 변환(옵션 적용)
        const data = await fileToDataUrlProcessed(items[i].file, {
          flattenPng: !!flatten.checked,
          bmpToJpeg: !!bmpAutoJpeg.checked,
          bmpQuality: Number(bmpQuality.value) || 0.85,
          maxPixels: 24_000_000, // 24MP로 캔버스 제한
        });

        const img = await loadImg(data);

        const pageW = doc.internal.pageSize.getWidth();
        const pageH = doc.internal.pageSize.getHeight();
        const m = Math.max(0, Number(margin.value)||0);
        const boxW = Math.max(0, pageW - 2*m);
        const boxH = Math.max(0, pageH - 2*m);

        const iw = img.naturalWidth || img.width;
        const ih = img.naturalHeight || img.height;
        let w, h;

        if (fit.value === 'original') {
          // 1px ≈ 0.264583mm
          w = iw * 0.264583; h = ih * 0.264583;
        } else {
          const br = boxW / boxH, ir = iw / ih;
          if (fit.value === 'contain') {
            if (ir > br) { w = boxW; h = w/ir; }
            else { h = boxH; w = h*ir; }
          } else { // cover
            if (ir > br) { h = boxH; w = h*ir; }
            else { w = boxW; h = w/ir; }
          }
        }

        let x = (pageW - w) / 2, y = (pageH - h) / 2;
        if (fit.value !== 'original') { x = Math.max(m, x); y = Math.max(m, y); }

        // jsPDF 타입 결정
        const type = data.startsWith('data:image/png') ? 'PNG' : 'JPEG';
        doc.addImage(data, type, x, y, w, h);
      }

      if (openNew.checked) {
        const url = doc.output('bloburl');
        window.open(url, '_blank'); // 사용자 클릭 이벤트 내에서 호출
      } else {
        doc.save('images.pdf');
      }
    }catch(e){
      console.error(e);
      alert('PDF 생성 중 오류가 발생했어요. 이미지 해상도/개수를 줄여 다시 시도해 주세요.');
    }
  });

  // ── 변환 유틸 ──────────────────────────────────────
  async function fileToDataUrlProcessed(file, opts){
    const { flattenPng, bmpToJpeg, bmpQuality, maxPixels } = opts;
    const raw = await read(file);

    // PNG: 투명 배경 흰색 합성 옵션
    if (/^image\/png$/i.test(file.type)) {
      if (!flattenPng) return raw;
      const img = await loadImg(raw);
      return rasterize(img, {to:'jpeg', quality:0.92, whiteBg:true, maxPixels});
    }

    // BMP: jsPDF가 BMP 직접 입력을 지원하지 않으므로 PNG 또는 JPEG로 변환
    if (/^image\/bmp$/i.test(file.type)) {
      const img = await loadImg(raw);
      if (bmpToJpeg) {
        return rasterize(img, {to:'jpeg', quality:clamp(bmpQuality,0.5,0.95), whiteBg:false, maxPixels});
      } else {
        return rasterize(img, {to:'png', whiteBg:false, maxPixels});
      }
    }

    // JPEG: 그대로 사용
    return raw;
  }

  function clamp(v,min,max){ return Math.max(min, Math.min(max, v)); }

  // 이미지 캔버스로 그려서 PNG/JPEG로 내보내기 (해상도 제한 포함)
  function rasterize(img, {to='png', quality=0.92, whiteBg=false, maxPixels=24_000_000}={}){
    const w = img.naturalWidth || img.width;
    const h = img.naturalHeight || img.height;
    let cw = w, ch = h, px = w*h;
    if (px > maxPixels) {
      const s = Math.sqrt(maxPixels/px);
      cw = Math.max(1, (w*s)|0);
      ch = Math.max(1, (h*s)|0);
    }
    const c = document.createElement('canvas');
    c.width = cw; c.height = ch;
    const g = c.getContext('2d');
    if (whiteBg) { g.fillStyle = '#fff'; g.fillRect(0,0,cw,ch); }
    if (cw!==w || ch!==h) g.drawImage(img,0,0,w,h, 0,0,cw,ch);
    else g.drawImage(img,0,0);

    if (to === 'jpeg') return c.toDataURL('image/jpeg', quality);
    return c.toDataURL('image/png');
  }

  function read(f){ return new Promise((res,rej)=>{ const r=new FileReader(); r.onload=e=>res(e.target.result); r.onerror=rej; r.readAsDataURL(f); }); }
  function loadImg(src){ return new Promise((res,rej)=>{ const i=new Image(); i.crossOrigin='anonymous'; i.onload=()=>res(i); i.onerror=rej; i.src=src; }); }
})();
</script>
</body>
</html>

